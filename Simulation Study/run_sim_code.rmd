---
title: "Spillover Simulation Study"
output: html_notebook
---

Read in prepped data:

```{r}
network_panel<-readRDS("/drives/drive1/54054dua/idata/cbobak/spillover_analysis/network_panel.rds")
```

Source functions:

```{r}
source("/drives/drive1/54054dua/programs/cbobak/spillover_analysis/simulation_study/simulation_block_code.R")
```

Run simulation:

```{r}
# (A) Correct model, contamination sweep for beta2 in {-1, 0, 1}
setA <- lapply(c(-1, 0, 1), function(b2)
  run_setting(R = 1000, network_panel = network_panel,
              exposure_truth = "proportion", team_agg = "sum",
              beta1 = log(1.15), beta2 = b2, beta3 = log(0.88),
              use_glmm = TRUE, seed = 1))

# (B) Interaction sweep with fixed positive spillover
setB <- lapply(c(-1, 0, 1), function(b3)
  run_setting(R = 1000, network_panel = network_panel,
              exposure_truth = "proportion", team_agg = "sum",
              beta1 = log(1.15), beta2 = log(2.8), beta3 = b3,
              use_glmm = TRUE, seed = 2))

# (C) Misspecified truth: threshold (fit still uses proportion because W is row-stochastic)
#     Here "exposure_truth" controls the DGP; the analysis model remains Post*Expose with Expose computed as proportion.
setC <- run_setting(R = 1000, network_panel = network_panel,
                    exposure_truth = "threshold", team_agg = "sum",
                    beta1 = log(1.15), beta2 = log(2.8), beta3 = log(0.88),
                    use_glmm = TRUE, seed = 3)

# 3) Inspect a summary
print(setA[[1]])
attr(setA[[1]], "elapsed_sec")
attr(setA[[1]], "R")

# 4) (Optional) bind all summaries
bind_summaries <- function(lst, label_vec) {
  do.call(rbind, Map(function(res, lab) {
    s <- res; s$setting <- lab; s
  }, lst, label_vec))
}

summA <- bind_summaries(setA, paste0("beta2=", c(-1,0,1)))
summB <- bind_summaries(setB, paste0("beta3=", c(-1,0,1)))
summ_all <- rbind(summA, summB, transform(setC, setting = "misspec_threshold"))
summ_all
```

Save output: 

```{r}
write.csv(summ_all,"/drives/drive1/54054dua/programs/cbobak/spillover_analysis/simulation_study/simulation_results.csv",row.names=F)
```
